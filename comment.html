<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/comment.css"/>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav top-color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">Comment</h1>
			<button class="mui-btn mui-pull-right public-btn" onclick="sendtoserver()">Send</button>
		</header>
		<div class="mui-content" >
			<div class="fbpyq-div public-padding">
				<textarea id="article" placeholder="Please enter the content message"></textarea>
			</div>
			<div>
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" id="imgModel">
							 Choose from album
						</a>
					</li>
					<ul class="mui-table-view mui-grid-view flex-ui" id="father">
						<li class="mui-table-view-cell mui-media mui-col-xs-4" id="final">
							<span class="mui-icon iconfont icon-add add-img" id="imgModel"></span>
							<input type="file" id="fileElem" accept="image/*" style="display:none" onchange="handleFiles(this.files)">
						</li>
					</ul>
					<input type="file" id="fileElem" accept="image/*" style="display:none" onchange="handleFiles(this.files)">
				</ul>
			</div>
		</div>
		<div class="pingfen">
			<h4 id="first">Grading</h4>
			<div style="padding-left:50px" id="xing">
				<img id="img1" class="starimg" src="images/xingxing2.png" width="40" height="40">
				<img id="img2" class="starimg" src="images/xingxing2.png" width="40" height="40">
				<img id="img3" class="starimg" src="images/xingxing2.png" width="40" height="40">
				<img id="img4" class="starimg" src="images/xingxing2.png" width="40" height="40">
				<img id="img5" class="starimg" src="images/xingxing2.png" width="40" height="40">
			</div>
		</div>
	</body>
	<script src="js/mui.js"></script>
	<script type="text/javascript">
		var storeId =1;
		if(typeof location.href.split('id=')[1] !='undefined'){
			storeId = location.href.split('id=')[1];
		}

		var SCORE = 1;
		var FILE_ID = 0;
		mui.init();
		var imgModel = document.getElementById("imgModel");
		var fileElem = document.getElementById("fileElem");

		const node1 = document.getElementById('img1');
		const node2 = document.getElementById('img2');
		const node3 = document.getElementById('img3');
		const node4 = document.getElementById('img4');
		const node5 = document.getElementById('img5');
		node1.addEventListener('touchstart', function (event) {
			if(this.src.indexOf('xingxing2')>0){
				SCORE = 1;
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing2.png';
				node3.src = 'images/xingxing2.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}else{
				node1.src = 'images/xingxing2.png';
				node2.src = 'images/xingxing2.png';
				node3.src = 'images/xingxing2.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}
		});
		node2.addEventListener('touchstart', function (event) {
			if(this.src.indexOf('xingxing2')>0){
				SCORE = 2;
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing2.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}else{
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing2.png';
				node3.src = 'images/xingxing2.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}
		});
		node3.addEventListener('touchstart', function (event) {
			if(this.src.indexOf('xingxing2')>0){
				SCORE = 3;
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing3.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}else{
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing2.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}
		});
		node4.addEventListener('touchstart', function (event) {
			if(this.src.indexOf('xingxing2')>0){
				SCORE = 4;
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing3.png';
				node4.src = 'images/xingxing3.png';
				node5.src = 'images/xingxing2.png';
			}else{
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing3.png';
				node4.src = 'images/xingxing2.png';
				node5.src = 'images/xingxing2.png';
			}
		});
		node5.addEventListener('touchstart', function (event) {
			if(this.src.indexOf('xingxing2')>0){
				SCORE = 5;
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing3.png';
				node4.src = 'images/xingxing3.png';
				node5.src = 'images/xingxing3.png';
			}else{
				node1.src = 'images/xingxing3.png';
				node2.src = 'images/xingxing3.png';
				node3.src = 'images/xingxing3.png';
				node4.src = 'images/xingxing3.png';
				node5.src = 'images/xingxing2.png';
			}
		});

		imgModel.addEventListener("tap", function (evt) {
			document.getElementById('fileElem').value = null;
			if (fileElem) {
				fileElem.click();
			}
			evt.preventDefault();
		}, false);

		function pub() {
			lis = document.getElementById('father').getElementsByTagName('li').length;
			var final = document.getElementById("final");
			if (lis == 4) {
				final.style.display = "none";
			} else {
				final.style.display = "inline"
			}
		}

		function guid() {
			return Number(Math.random().toString().substr(3, 3) + Date.now()).toString(36);
		}

		function handleFiles(files) {
			if (files.length) {
				var file = files[0];
				var fileReader = new FileReader();
				fileReader.onload = function () {
					uuid = ++FILE_ID;
					lis = document.getElementById('father').getElementsByTagName('li').length;
					if (lis < 4) {
						var father = document.getElementById("father");
						var final = document.getElementById("final");
						var li = document.createElement('li');
						li.className = "mui-table-view-cell mui-media mui-col-xs-4 delete-ico";
						li.id = 'id' + uuid;
						li.innerHTML = '<img class="mui-media-object" id="img' + uuid + '" src="">' +
							'<input type="file" id="input' + uuid + '" accept="image/*" style="display:none">' +
							'<span class="mui-icon iconfont icon-delete delete-btn" id="d' + uuid + '"></span>';
						father.appendChild(li);
						var ids = document.getElementById('id' + uuid);
						father.insertBefore(ids, final);

						document.getElementById('img' + uuid).src = fileReader.result;
						idcard = fileReader.result;
						pub();
					} else {
						mui.toast('亲、照片只能上传3张！');
					}

				};
				fileReader.readAsDataURL(file);
			}
		}

		Date.prototype.Format = function (fmt) { //author: meizz
		    var o = {
		        "M+": this.getMonth() + 1, //月份
		        "d+": this.getDate(), //日
		        "h+": this.getHours(), //小时
		        "m+": this.getMinutes(), //分
		        "s+": this.getSeconds(), //秒
		        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
		        "S": this.getMilliseconds() //毫秒
		    };
		    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
		    for (var k in o)
		    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
		    return fmt;
		}

		function compress(img) {
			var canvas = document.createElement("canvas");
			var ctx = canvas.getContext('2d');
			var tCanvas = document.createElement("canvas");
			var tctx = tCanvas.getContext("2d");
			var initSize = img.src.length;
			var width = img.width;
			var height = img.height;
			//如果图片大于四百万像素，计算压缩比并将大小压至400万以下
			var ratio;
			if ((ratio = width * height / 4000000)>1) {
				ratio = Math.sqrt(ratio);
				width /= ratio;
				height /= ratio;
			}else {
				ratio = 1;
			}
			canvas.width = width;
			canvas.height = height;
			//铺底色
			ctx.fillStyle = "#fff";
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			//如果图片像素大于100万则使用瓦片绘制
			var count;
			if ((count = width * height / 1000000) > 1) {
				count = ~~(Math.sqrt(count)+1); //计算要分成多少块瓦片
				//计算每块瓦片的宽和高
				var nw = ~~(width / count);
				var nh = ~~(height / count);
				tCanvas.width = nw;
				tCanvas.height = nh;
				for (var i = 0; i < count; i++) {
					for (var j = 0; j < count; j++) {
						tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);
						ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
					}
				}
			} else {
				ctx.drawImage(img, 0, 0, width, height);
			}
			//进行最小压缩
			var ndata = canvas.toDataURL('image/jpeg', 0.6);
			console.log('压缩前：' + initSize);
			console.log('压缩后：' + ndata.length);
			console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");
			tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;
			return ndata;
		}

		function sendtoserver(){
			const article = document.getElementById('article').value;
			const now = new Date().Format("yyyy-MM-dd hh:mm:ss");

			var data1 = '';
			if(typeof document.getElementById('img1').src !='undefined'){
				var url1 = document.getElementById('img1').src;
				var img1 = new Image();
				img1.src = url1;
				data1 = compress(img1);
			}

			var data2 = '';
			if(typeof document.getElementById('img2').src !='undefined'){
				var url2 = document.getElementById('img2').src;
				var img2 = new Image();
				img2.src = url2;
				data2 = compress(img2);
			}
			var data3 = '';
			if(typeof document.getElementById('img3').src !='undefined'){
				var url3 = document.getElementById('img3').src
				var img3 = new Image();
				img3.src = url3;
				data3 = compress(img3);
			}

			// mui.showLoading("正在发送....","div");
			var mask = mui.createMask(function(){
				return '正在发送....';
			});
			mask.show();
			mui.ajax('http://kaopu-campus.online/kaopuUI/think/public/StoreComment',{
				data:{
					'store_id':storeId,
					'article':article,
					'owner':1,
					'rate':SCORE,
					'create_time':now,
					'image1':JSON.stringify(data1),
					'image2':JSON.stringify(data2),
					'image3':JSON.stringify(data3)
				},
				type: 'post',
				dataType: "json",
				timeout: 10000,
				headers: {'Content-Type': 'application/json'},
				success: function (data) {
					mask.close();
					alert('Comment on success')
				},
				error: function (xhr, type, errorThrown) {
					console.log(type);
				}
			});
		}
	</script>
</html>
